@model IEnumerable<MODELO_DATOS.MODELO_REQUISICION.REQUISICIONViewModel>
@using UTILS.Settings
@using MODELO_DATOS.MODELO_REQUISICION;
@{
    //ViewBag.Title = "retiros_buscar";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="~/Scripts/jquery.dataTables.min.js"></script>
<div class="col-md-9 col-lg-9 col-xl-9 tablaRetiros">

    <div class="col-lg-12 col-md-12 col-sm-12 row">
        <h2 class="titulo-retiros col-md-12">Requisiciones</h2>
        @if (User.IsInRole(SettingsManager.PerfilJefe))
        {
            <div class="margenbottton col-lg-12 col-md-12 col-sm-12 row">
                <div class="col-md-4">
                    <a href="" data-toggle="modal" data-target="#Modal" style="font-size:small; font-weight:bold">+ CREAR NUEVA REQUISICIÓN</a>
                </div>
            </div>
        }
        <div class="col-lg-12 col-md-12 col-sm-12 row">
            <div class="buscador" style="width:100%;">
                <input class="search-input" id="filtroPorUsuarioValor" type="text" placeholder=" Nombre o cédula" style="width:100%; height:  100%;">
                <span id="filtroPorUsuario" class="search-btn fas fa-search"></span>
            </div>
        </div>
    </div>





    <div class="col-lg-12 col-md-12 col-sm-12 row">

        <div class="form-group col-md-4">
            <label class="label">Filtre Por tipo</label>
            @Html.DropDownList("ddlTipo", new SelectList(ViewBag.Tipo, "Value", "Text"), "Seleccione ", new { @class = "form-control", @style = "height: 48px;", @id = "filtroTipo" })

        </div>


        <div class="form-group col-md-4">
            <label>Filtre Por Fecha</label>
            <input type="date" class="form-control" id="txtFiltroFecha" style="height: 48px;" />

        </div>


        <div class="form-group col-md-4">
            <label class="label">Filtre Por Estado</label>
            @Html.DropDownList("ddlEstado", new SelectList(ViewBag.Estado, "Value", "Text", ViewBag.valorSeleccionado), "Seleccione  ", new { @class = "form-control", @style = "height: 48px;", id = "filtroEstados" })
        </div>

    </div>
    <div class="table-wrapper">

        <table class="tabla-retiro table" id="tblRequisiciones">

            <thead>
                <tr style="height:62px;">

                    <th>
                        @Html.DisplayNameFor(model => model.USUARIO_CREACION)&nbsp;<span class="fas fa-sort-down"></span>
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.NOMBRE_CARGO)&nbsp;<span class="fas fa-sort-down"></span>
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.NOMBRE_EMPLEADO)&nbsp;<span class="fas fa-sort-down"></span>
                    </th>

                    <th>
                        @Html.DisplayNameFor(model => model.NOMBRE_TIPO_REQUISICION)&nbsp;<span class="fas fa-sort-down"></span>
                    </th>

                    <th>
                        @Html.DisplayNameFor(model => model.FECHA_CREACION)&nbsp;<span class="fas fa-sort-down"></span>
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.NOMBRE_ESTADO_REQUISICION)&nbsp;<span class="fas fa-sort-down"></span>
                    </th>
                </tr>
            </thead>

            <tbody id="tblBody">
                @if (Model.Any())
                {
                    foreach (var item in Model)
                    {

                        <tr style="height:62px;">


                            <td class="td">
                                @if (!User.IsInRole(SettingsManager.PerfilJefe) && !User.IsInRole(SettingsManager.PerfilBp))
                                {
                                    <a class="alineas" href="@Url.Action("Detalle", "REQUISICION", new { _idRequisicion = item.COD_REQUISICION, _tipoRequisicion = item.COD_TIPO_REQUISICION })">
                                        <row style="color: blue;font-weight: bold;">@Html.DisplayFor(modelItem => item.NOMBRES_USUARIO)</row>
                                        <span class="td-email">
                                            @Html.DisplayFor(modelItem => item.USUARIO_CREACION)
                                        </span>
                                        <span class="td-email">@Html.DisplayFor(mItem => item.EMAIL_USUARIO_CREACION)</span>
                                    </a>
                                }
                                else if (User.IsInRole(SettingsManager.PerfilBp))
                                {
                                    if (item.COD_ESTADO_REQUISICION == SettingsManager.EstadoAporbadoController || item.COD_ESTADO_REQUISICION == SettingsManager.EstadoDevueltaRRHH || item.COD_ESTADO_REQUISICION == SettingsManager.EstadoDevueltaUSC || item.COD_ESTADO_REQUISICION == SettingsManager.EstadoAprobadoJefe)
                                    {
                                        <a class="alineas" href="@Url.Action("Detalle", "REQUISICION", new { _idRequisicion = item.COD_REQUISICION, _tipoRequisicion = item.COD_TIPO_REQUISICION })">
                                            <row style="color: blue;font-weight: bold;">@Html.DisplayFor(modelItem => item.NOMBRES_USUARIO)</row>
                                            <span class="td-email">
                                                @Html.DisplayFor(modelItem => item.USUARIO_CREACION)
                                            </span>
                                            <span class="td-email">@Html.DisplayFor(mItem => item.EMAIL_USUARIO_CREACION)</span>
                                        </a>
                                    }
                                    else
                                    {
                                        <row style="color: blue;font-weight: bold;">
                                            @Html.DisplayFor(modelItem => item.NOMBRES_USUARIO)
                                        </row>
                                        <span class="td-email">
                                            @Html.DisplayFor(modelItem => item.USUARIO_CREACION)
                                        </span>
                                        <span class="td-email">@Html.DisplayFor(mItem => item.EMAIL_USUARIO_CREACION)</span>
                                    }
                                }
                                else
                                {
                                    if (item.COD_ESTADO_REQUISICION == SettingsManager.EstadoDevueltaController)
                                    {
                                        <a class="alineas" href="@Url.Action("Detalle", "REQUISICION", new { _idRequisicion = item.COD_REQUISICION, _tipoRequisicion = item.COD_TIPO_REQUISICION })">
                                            <row style="color: blue;font-weight: bold;">
                                                @Html.DisplayFor(modelItem => item.NOMBRES_USUARIO)
                                            </row>
                                            <span class="td-email">
                                                @Html.DisplayFor(modelItem => item.USUARIO_CREACION)
                                            </span>
                                            <span class="td-email">@Html.DisplayFor(mItem => item.EMAIL_USUARIO_CREACION)</span>
                                        </a>
                                    }
                                    else
                                    {
                                        <row style="color: blue;font-weight: bold;">
                                            @Html.DisplayFor(modelItem => item.NOMBRES_USUARIO)
                                        </row>
                                        <span class="td-email">
                                            @Html.DisplayFor(modelItem => item.USUARIO_CREACION)
                                        </span>
                                        <span class="td-email">@Html.DisplayFor(mItem => item.EMAIL_USUARIO_CREACION)</span>
                                    }
                                }

                            </td>
                            <td class="td-causal">@Html.DisplayFor(modelItem => item.NOMBRE_CARGO)<span class="td-email">@Html.DisplayFor(mItem => item.COD_CARGO)</span></td>

                            <td class="td-causal">
                                <row style="color: blue;font-weight: bold;">
                                    @Html.DisplayFor(modelItem => item.NOMBRE_EMPLEADO)
                                </row>
                                <span class="td-email"> @Html.DisplayFor(modelItem => item.NUMERO_DOCUMENTO_EMPLEADO)</span>
                            </td>

                            <td class="td-acciones">

                                @if (item.ES_MODIFICACION)
                                {
                                    <label>Modificacion</label>

                                }
                                else
                                {
                                    @Html.DisplayFor(modelItem => item.NOMBRE_TIPO_REQUISICION)
                                }

                            </td>
                            <td>@Html.DisplayFor(modelItem => item.FECHA_CREACION)</td>
                            <td><font color="@item.COLORES_ESTADOS">@Html.DisplayFor(modelItem => item.NOMBRE_ESTADO_REQUISICION)</font></td>
                        </tr>

                    }
                }
                else
                {
                    <tr>
                        <td>
                            No existe información
                        </td>
                        <td>
                            No existe información
                        </td>
                        <td>
                            No existe información
                        </td>
                        <td>
                            No existe información
                        </td>
                        <td>
                            No existe información
                        </td>
                        <td>
                            No existe información
                        </td>

                    </tr>
                }

            </tbody>


        </table>

    </div>
</div>

<div>

</div>



<!-- Modal -->
<div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalLabel">Crear Requisición</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="row modal-body">
                <div class="col-md-12 col-lg-12 col-xl-12">
                    Seleccione una opción de Requisición
                </div>
                @Html.Partial("_SelectRequisicion")
            </div>
        </div>
    </div>
</div>



<script type="text/javascript">

    $(document).ready(function () {
        ConsultaModificaciones();

        var table = $('#tblRequisiciones').DataTable({
            paging: false,
            orderCellsTop: false,
            fixedHeader: false,
            language: {
                "sZeroRecords": "No se encontraron resultados"
            }
        });


        $('#filtroPorUsuario').on('click', function () {
            table.column(2).search($('#filtroPorUsuarioValor').val()).draw();
        });


        $('#txtFiltroFecha').change(function () {
            if (table.column(4).search() !== this.value) {
                table
                    .column(4)
                    .search(this.value.split('-').reverse().join('/'))
                    .draw();
            }
            $('.dataTables_empty').css("display", "none");
        });


        $('#filtroTipo').on('change', function () {
            if ($('#filtroTipo option:selected').val() == "") {
                table.column(3).search("").draw();
            }
            else {
                table.column(3).search("^" + $('#filtroTipo option:selected').text() + "$", true, false, true).draw();
            }
        });

        $('#filtroEstados').on('change', function () {
            debugger;
            if ($('#filtroEstados option:selected').val() == "") {
                table.column(5).search("").draw();
            }
            else {
                table.column(5).search($('#filtroEstados option:selected').text()).draw();
            }
        });


        $('.dataTables_filter').css("display", "none");
        $('.dataTables_info').css("display", "none");

    });



    function ConsultaModificaciones() {
        $("#notificationsBadgePrimary").text("");
        $("#AddNotificaciones").text("");
          debugger;
            $('body').loading({
                message: 'Cargando...'
            });
            $.ajax({
                url: "@Url.Action("ConsultarModificaciones", "REQUISICION")",
                type: 'POST',
                data: null,
                success: function (respuesta) {
                    $.each(respuesta, function (key, value) {
                        $("#notificationsBadgePrimary").text(value.TOTAL);
                        $("#AddNotificaciones").append('<a class="dropdown-item dropdown-notification" href="#"><div class="notification-read"><span class="badge badge-secondary">' + value.CANTIDAD + '</span></div><div class="notifications-body"><p class="notification-texte">Tienes ' + value.CANTIDAD + ' Requisiciones ' + value.NOMBRE_REQUISICION +' para tramitar </p></div></a>')
                    });
                    debugger;
                    $('body').loading('stop');
                    $('.ModalTraza').modal("show");
                },
                error: function (er){
                    $('body').loading('stop');
                }
            });
        }
</script>
